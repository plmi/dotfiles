#/usr/bin/env bash

# Usage: target 1.1.1.1 htb-foo
# sets $IP="1.1.1.1" and $TARGET_NAME="htb-foo"

# Load the current target into IP for each new shell.
if [ -f "$HOME/.target" ]; then
  IP="$(head -n1 "$HOME/.target" | tr -d '\r')"
  if [ -n "$IP" ]; then
    export IP
  else
    unset IP
  fi
fi
if [ -f "$HOME/.target_name" ]; then
  TARGET_NAME="$(head -n1 "$HOME/.target_name" | tr -d '\r')"
  if [ -n "$TARGET_NAME" ] && [ "$TARGET_NAME" != "unset" ]; then
    export TARGET_NAME
  else
    unset TARGET_NAME
  fi
fi

# Wrapper keeps ~/.target and $IP in sync in the current shell.
target() {
  if command target "$@"; then
    local new_ip
    local new_target_name
    new_ip="$(head -n1 "$HOME/.target" 2>/dev/null | tr -d '\r')"
    if [ -n "$new_ip" ]; then
      export IP="$new_ip"
    else
      unset IP
    fi
    new_target_name="$(head -n1 "$HOME/.target_name" 2>/dev/null | tr -d '\r')"
    if [ -n "$new_target_name" ] && [ "$new_target_name" != "unset" ]; then
      export TARGET_NAME="$new_target_name"
    else
      unset TARGET_NAME
    fi
  fi
}
